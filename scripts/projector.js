THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(a){this.positionWorld.copy(a.positionWorld),this.positionScreen.copy(a.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){function L(){if(b===d){var a=new THREE.RenderableObject;return c.push(a),d++,b++,a}return c[b++]}function M(){if(f===h){var a=new THREE.RenderableVertex;return g.push(a),h++,f++,a}return g[f++]}function N(){if(j===l){var a=new THREE.RenderableFace;return k.push(a),l++,j++,a}return k[j++]}function O(){if(n===p){var a=new THREE.RenderableLine;return o.push(a),p++,n++,a}return o[n++]}function P(){if(r===t){var a=new THREE.RenderableSprite;return s.push(a),t++,r++,a}return s[r++]}function Q(a,b){return a.renderOrder!==b.renderOrder?a.renderOrder-b.renderOrder:a.z!==b.z?b.z-a.z:a.id!==b.id?a.id-b.id:0}function R(a,b){var c=0,d=1,e=a.z+a.w,f=b.z+b.w,g=-a.z+a.w,h=-b.z+b.w;return e>=0&&f>=0&&g>=0&&h>=0||!(e<0&&f<0||g<0&&h<0)&&(e<0?c=Math.max(c,e/(e-f)):f<0&&(d=Math.min(d,e/(e-f))),g<0?c=Math.max(c,g/(g-h)):h<0&&(d=Math.min(d,g/(g-h))),!(d<c)&&(a.lerp(b,c),b.lerp(a,1-d),!0))}var a,b,e,f,i,j,m,n,q,r,D,c=[],d=0,g=[],h=0,k=[],l=0,o=[],p=0,s=[],t=0,u={objects:[],lights:[],elements:[]},v=new THREE.Vector3,w=new THREE.Vector4,x=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),y=new THREE.Box3,z=new Array(3),B=(new Array(4),new THREE.Matrix4),C=new THREE.Matrix4,E=new THREE.Matrix4,F=new THREE.Matrix3,G=new THREE.Frustum,H=new THREE.Vector4,I=new THREE.Vector4;this.projectVector=function(a,b){console.warn("THREE.Projector: .projectVector() is now vector.project()."),a.project(b)},this.unprojectVector=function(a,b){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),a.unproject(b)},this.pickingRay=function(a,b){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var J=function(){function h(e){c=e,d=c.material,f.getNormalMatrix(c.matrixWorld),a.length=0,b.length=0}function j(a){var b=a.position,c=a.positionWorld,d=a.positionScreen;c.copy(b).applyMatrix4(D),d.copy(c).applyMatrix4(C);var e=1/d.w;d.x*=e,d.y*=e,d.z*=e,a.visible=d.x>=-1&&d.x<=1&&d.y>=-1&&d.y<=1&&d.z>=-1&&d.z<=1}function k(a,b,c){e=M(),e.position.set(a,b,c),j(e)}function l(b,c,d){a.push(b,c,d)}function n(a,c){b.push(a,c)}function o(a,b,c){return a.visible===!0||b.visible===!0||c.visible===!0||(z[0]=a.positionScreen,z[1]=b.positionScreen,z[2]=c.positionScreen,x.intersectsBox(y.setFromPoints(z)))}function p(a,b,c){return(c.positionScreen.x-a.positionScreen.x)*(b.positionScreen.y-a.positionScreen.y)-(c.positionScreen.y-a.positionScreen.y)*(b.positionScreen.x-a.positionScreen.x)<0}function q(a,b){var d=g[a],e=g[b];m=O(),m.id=c.id,m.v1.copy(d),m.v2.copy(e),m.z=(d.positionScreen.z+e.positionScreen.z)/2,m.renderOrder=c.renderOrder,m.material=c.material,u.elements.push(m)}function r(e,h,j){var k=g[e],l=g[h],m=g[j];if(o(k,l,m)!==!1&&(d.side===THREE.DoubleSide||p(k,l,m)===!0)){i=N(),i.id=c.id,i.v1.copy(k),i.v2.copy(l),i.v3.copy(m),i.z=(k.positionScreen.z+l.positionScreen.z+m.positionScreen.z)/3,i.renderOrder=c.renderOrder,i.normalModel.fromArray(a,3*e),i.normalModel.applyMatrix3(f).normalize();for(var n=0;n<3;n++){var q=i.vertexNormalsModel[n];q.fromArray(a,3*arguments[n]),q.applyMatrix3(f).normalize();var r=i.uvs[n];r.fromArray(b,2*arguments[n])}i.vertexNormalsLength=3,i.material=c.material,u.elements.push(i)}}var a=[],b=[],c=null,d=null,f=new THREE.Matrix3;return{setObject:h,projectVertex:j,checkTriangleVisibility:o,checkBackfaceCulling:p,pushVertex:k,pushNormal:l,pushUv:n,pushLine:q,pushTriangle:r}},K=new J;this.projectScene=function(c,d,e,h){function k(b){a=L(),a.id=b.id,a.object=b,v.setFromMatrixPosition(b.matrixWorld),v.applyProjection(C),a.z=v.z,a.renderOrder=b.renderOrder,u.objects.push(a)}j=0,n=0,r=0,u.elements.length=0,c.autoUpdate===!0&&c.updateMatrixWorld(),null===d.parent&&d.updateMatrixWorld(),B.copy(d.matrixWorldInverse.getInverse(d.matrixWorld)),C.multiplyMatrices(d.projectionMatrix,B),G.setFromMatrix(C),b=0,u.objects.length=0,u.lights.length=0,c.traverseVisible(function(a){if(a instanceof THREE.Light)u.lights.push(a);else if(a instanceof THREE.Mesh||a instanceof THREE.Line){if(a.material.visible===!1)return;if(a.frustumCulled===!0&&G.intersectsObject(a)===!1)return;k(a)}else if(a instanceof THREE.Sprite){if(a.material.visible===!1)return;if(a.frustumCulled===!0&&G.intersectsSprite(a)===!1)return;k(a)}}),e===!0&&u.objects.sort(Q);for(var l=0,o=u.objects.length;l<o;l++){var p=u.objects[l].object,s=p.geometry;if(K.setObject(p),D=p.matrixWorld,f=0,p instanceof THREE.Mesh){if(s instanceof THREE.BufferGeometry){var t=s.attributes,x=s.groups;if(void 0===t.position)continue;for(var y=t.position.array,z=0,A=y.length;z<A;z+=3)K.pushVertex(y[z],y[z+1],y[z+2]);if(void 0!==t.normal)for(var J=t.normal.array,z=0,A=J.length;z<A;z+=3)K.pushNormal(J[z],J[z+1],J[z+2]);if(void 0!==t.uv)for(var S=t.uv.array,z=0,A=S.length;z<A;z+=2)K.pushUv(S[z],S[z+1]);if(null!==s.index){var T=s.index.array;if(x.length>0)for(var l=0;l<x.length;l++)for(var U=x[l],z=U.start,A=U.start+U.count;z<A;z+=3)K.pushTriangle(T[z],T[z+1],T[z+2]);else for(var z=0,A=T.length;z<A;z+=3)K.pushTriangle(T[z],T[z+1],T[z+2])}else for(var z=0,A=y.length/3;z<A;z+=3)K.pushTriangle(z,z+1,z+2)}else if(s instanceof THREE.Geometry){var V=s.vertices,W=s.faces,X=s.faceVertexUvs[0];F.getNormalMatrix(D);for(var Y=p.material,Z=Y instanceof THREE.MultiMaterial,$=Z===!0?p.material:null,_=0,aa=V.length;_<aa;_++){var ba=V[_];if(v.copy(ba),Y.morphTargets===!0)for(var ca=s.morphTargets,da=p.morphTargetInfluences,ea=0,fa=ca.length;ea<fa;ea++){var ga=da[ea];if(0!==ga){var ha=ca[ea],ia=ha.vertices[_];v.x+=(ia.x-ba.x)*ga,v.y+=(ia.y-ba.y)*ga,v.z+=(ia.z-ba.z)*ga}}K.pushVertex(v.x,v.y,v.z)}for(var ja=0,ka=W.length;ja<ka;ja++){var la=W[ja];if(Y=Z===!0?$.materials[la.materialIndex]:p.material,void 0!==Y){var ma=Y.side,na=g[la.a],oa=g[la.b],pa=g[la.c];if(K.checkTriangleVisibility(na,oa,pa)!==!1){var qa=K.checkBackfaceCulling(na,oa,pa);if(ma!==THREE.DoubleSide){if(ma===THREE.FrontSide&&qa===!1)continue;if(ma===THREE.BackSide&&qa===!0)continue}i=N(),i.id=p.id,i.v1.copy(na),i.v2.copy(oa),i.v3.copy(pa),i.normalModel.copy(la.normal),qa!==!1||ma!==THREE.BackSide&&ma!==THREE.DoubleSide||i.normalModel.negate(),i.normalModel.applyMatrix3(F).normalize();for(var ra=la.vertexNormals,sa=0,ta=Math.min(ra.length,3);sa<ta;sa++){var ua=i.vertexNormalsModel[sa];ua.copy(ra[sa]),qa!==!1||ma!==THREE.BackSide&&ma!==THREE.DoubleSide||ua.negate(),ua.applyMatrix3(F).normalize()}i.vertexNormalsLength=ra.length;var va=X[ja];if(void 0!==va)for(var wa=0;wa<3;wa++)i.uvs[wa].copy(va[wa]);i.color=la.color,i.material=Y,i.z=(na.positionScreen.z+oa.positionScreen.z+pa.positionScreen.z)/3,i.renderOrder=p.renderOrder,u.elements.push(i)}}}}}else if(p instanceof THREE.Line){if(s instanceof THREE.BufferGeometry){var t=s.attributes;if(void 0!==t.position){for(var y=t.position.array,z=0,A=y.length;z<A;z+=3)K.pushVertex(y[z],y[z+1],y[z+2]);if(null!==s.index)for(var T=s.index.array,z=0,A=T.length;z<A;z+=2)K.pushLine(T[z],T[z+1]);else for(var xa=p instanceof THREE.LineSegments?2:1,z=0,A=y.length/3-1;z<A;z+=xa)K.pushLine(z,z+1)}}else if(s instanceof THREE.Geometry){E.multiplyMatrices(C,D);var V=p.geometry.vertices;if(0===V.length)continue;na=M(),na.positionScreen.copy(V[0]).applyMatrix4(E);for(var xa=p instanceof THREE.LineSegments?2:1,_=1,aa=V.length;_<aa;_++)na=M(),na.positionScreen.copy(V[_]).applyMatrix4(E),(_+1)%xa>0||(oa=g[f-2],H.copy(na.positionScreen),I.copy(oa.positionScreen),R(H,I)===!0&&(H.multiplyScalar(1/H.w),I.multiplyScalar(1/I.w),m=O(),m.id=p.id,m.v1.positionScreen.copy(H),m.v2.positionScreen.copy(I),m.z=Math.max(H.z,I.z),m.renderOrder=p.renderOrder,m.material=p.material,p.material.vertexColors===THREE.VertexColors&&(m.vertexColors[0].copy(p.geometry.colors[_]),m.vertexColors[1].copy(p.geometry.colors[_-1])),u.elements.push(m)))}}else if(p instanceof THREE.Sprite){w.set(D.elements[12],D.elements[13],D.elements[14],1),w.applyMatrix4(C);var ya=1/w.w;w.z*=ya,w.z>=-1&&w.z<=1&&(q=P(),q.id=p.id,q.x=w.x*ya,q.y=w.y*ya,q.z=w.z,q.renderOrder=p.renderOrder,q.object=p,q.rotation=p.rotation,q.scale.x=p.scale.x*Math.abs(q.x-(w.x+d.projectionMatrix.elements[0])/(w.w+d.projectionMatrix.elements[12])),q.scale.y=p.scale.y*Math.abs(q.y-(w.y+d.projectionMatrix.elements[5])/(w.w+d.projectionMatrix.elements[13])),q.material=p.material,u.elements.push(q))}}return h===!0&&u.elements.sort(Q),u}};