THREE.SpriteCanvasMaterial=function(a){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(a,b){},this.setValues(a)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var a=new THREE.SpriteCanvasMaterial;return a.copy(this),a.color.copy(this.color),a.program=this.program,a},THREE.CanvasRenderer=function(a){function ta(){ma.setRGB(0,0,0),na.setRGB(0,0,0),oa.setRGB(0,0,0);for(var a=0,b=e.length;a<b;a++){var c=e[a],d=c.color;c instanceof THREE.AmbientLight?ma.add(d):c instanceof THREE.DirectionalLight?na.add(d):c instanceof THREE.PointLight&&oa.add(d)}}function ua(a,b,c){for(var d=0,f=e.length;d<f;d++){var g=e[d];if(_.copy(g.color),g instanceof THREE.DirectionalLight){var h=pa.setFromMatrixPosition(g.matrixWorld).normalize(),i=b.dot(h);if(i<=0)continue;i*=g.intensity,c.add(_.multiplyScalar(i))}else if(g instanceof THREE.PointLight){var h=pa.setFromMatrixPosition(g.matrixWorld),i=b.dot(pa.subVectors(h,a).normalize());if(i<=0)continue;if(i*=0==g.distance?1:1-Math.min(a.distanceTo(h)/g.distance,1),0==i)continue;i*=g.intensity,c.add(_.multiplyScalar(i))}}}function va(a,b,c){Fa(c.opacity),Ga(c.blending);var d=b.scale.x*j,e=b.scale.y*k,f=.5*Math.sqrt(d*d+e*e);if(la.min.set(a.x-f,a.y-f),la.max.set(a.x+f,a.y+f),c instanceof THREE.SpriteMaterial){var g=c.map;if(null!==g){var h=aa[g.id];if(void 0!==h&&h.version===g.version||(h=Ba(g),aa[g.id]=h),void 0!==h.canvas){La(h.canvas);var i=g.image,l=i.width*g.offset.x,m=i.height*g.offset.y,n=i.width*g.repeat.x,o=i.height*g.repeat.y,p=d/n,r=e/o;q.save(),q.translate(a.x,a.y),0!==c.rotation&&q.rotate(c.rotation),q.translate(-d/2,-e/2),q.scale(p,r),q.translate(-l,-m),q.fillRect(l,m,n,o),q.restore()}}else La(c.color.getStyle()),q.save(),q.translate(a.x,a.y),0!==c.rotation&&q.rotate(c.rotation),q.scale(d,-e),q.fillRect(-.5,-.5,1,1),q.restore()}else c instanceof THREE.SpriteCanvasMaterial&&(Ka(c.color.getStyle()),La(c.color.getStyle()),q.save(),q.translate(a.x,a.y),0!==c.rotation&&q.rotate(c.rotation),q.scale(d,e),c.program(q),q.restore())}function wa(a,b,c,d){if(Fa(d.opacity),Ga(d.blending),q.beginPath(),q.moveTo(a.positionScreen.x,a.positionScreen.y),q.lineTo(b.positionScreen.x,b.positionScreen.y),d instanceof THREE.LineBasicMaterial){if(Ha(d.linewidth),Ia(d.linecap),Ja(d.linejoin),d.vertexColors!==THREE.VertexColors)Ka(d.color.getStyle());else{var e=c.vertexColors[0].getStyle(),f=c.vertexColors[1].getStyle();if(e===f)Ka(e);else{try{var g=q.createLinearGradient(a.positionScreen.x,a.positionScreen.y,b.positionScreen.x,b.positionScreen.y);g.addColorStop(0,e),g.addColorStop(1,f)}catch(a){g=e}Ka(g)}}q.stroke(),la.expandByScalar(2*d.linewidth)}else d instanceof THREE.LineDashedMaterial&&(Ha(d.linewidth),Ia(d.linecap),Ja(d.linejoin),Ka(d.color.getStyle()),Ma([d.dashSize,d.gapSize]),q.stroke(),la.expandByScalar(2*d.linewidth),Ma([]))}function xa(a,c,d,e,f,g,h,i){if(b.info.render.vertices+=3,b.info.render.faces++,Fa(i.opacity),Ga(i.blending),I=a.positionScreen.x,J=a.positionScreen.y,K=c.positionScreen.x,L=c.positionScreen.y,M=d.positionScreen.x,N=d.positionScreen.y,ya(I,J,K,L,M,N),(i instanceof THREE.MeshLambertMaterial||i instanceof THREE.MeshPhongMaterial)&&null===i.map)Z.copy(i.color),$.copy(i.emissive),i.vertexColors===THREE.FaceColors&&Z.multiply(h.color),U.copy(ma),qa.copy(a.positionWorld).add(c.positionWorld).add(d.positionWorld).divideScalar(3),ua(qa,h.normalModel,U),U.multiply(Z).add($),i.wireframe===!0?za(U,i.wireframeLinewidth,i.wireframeLinecap,i.wireframeLinejoin):Aa(U);else if(i instanceof THREE.MeshBasicMaterial||i instanceof THREE.MeshLambertMaterial||i instanceof THREE.MeshPhongMaterial)if(null!==i.map){var j=i.map.mapping;j===THREE.UVMapping&&(ca=h.uvs,Ca(I,J,K,L,M,N,ca[e].x,ca[e].y,ca[f].x,ca[f].y,ca[g].x,ca[g].y,i.map))}else null!==i.envMap?i.envMap.mapping===THREE.SphericalReflectionMapping&&(ra.copy(h.vertexNormalsModel[e]).applyMatrix3(sa),da=.5*ra.x+.5,ea=.5*ra.y+.5,ra.copy(h.vertexNormalsModel[f]).applyMatrix3(sa),fa=.5*ra.x+.5,ga=.5*ra.y+.5,ra.copy(h.vertexNormalsModel[g]).applyMatrix3(sa),ha=.5*ra.x+.5,ia=.5*ra.y+.5,Ca(I,J,K,L,M,N,da,ea,fa,ga,ha,ia,i.envMap)):(U.copy(i.color),i.vertexColors===THREE.FaceColors&&U.multiply(h.color),i.wireframe===!0?za(U,i.wireframeLinewidth,i.wireframeLinecap,i.wireframeLinejoin):Aa(U));else i instanceof THREE.MeshNormalMaterial?(ra.copy(h.normalModel).applyMatrix3(sa),U.setRGB(ra.x,ra.y,ra.z).multiplyScalar(.5).addScalar(.5),i.wireframe===!0?za(U,i.wireframeLinewidth,i.wireframeLinecap,i.wireframeLinejoin):Aa(U)):(U.setRGB(1,1,1),i.wireframe===!0?za(U,i.wireframeLinewidth,i.wireframeLinecap,i.wireframeLinejoin):Aa(U))}function ya(a,b,c,d,e,f){q.beginPath(),q.moveTo(a,b),q.lineTo(c,d),q.lineTo(e,f),q.closePath()}function za(a,b,c,d){Ha(b),Ia(c),Ja(d),Ka(a.getStyle()),q.stroke(),la.expandByScalar(2*b)}function Aa(a){La(a.getStyle()),q.fill()}function Ba(a){if(0===a.version||a instanceof THREE.CompressedTexture||a instanceof THREE.DataTexture)return{canvas:void 0,version:a.version};var b=a.image;if(b.complete===!1)return{canvas:void 0,version:0};var c=document.createElement("canvas");c.width=b.width,c.height=b.height;var d=c.getContext("2d");d.setTransform(1,0,0,-1,0,b.height),d.drawImage(b,0,0);var e=a.wrapS===THREE.RepeatWrapping,f=a.wrapT===THREE.RepeatWrapping,g="no-repeat";e===!0&&f===!0?g="repeat":e===!0?g="repeat-x":f===!0&&(g="repeat-y");var h=q.createPattern(c,g);return a.onUpdate&&a.onUpdate(a),{canvas:h,version:a.version}}function Ca(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=aa[m.id];if(void 0!==n&&n.version===m.version||(n=Ba(m),aa[m.id]=n),void 0===n.canvas)return La("rgba( 0, 0, 0, 1)"),void q.fill();La(n.canvas);var o,p,r,s,t,u,v,w,x=m.offset.x/m.repeat.x,y=m.offset.y/m.repeat.y,z=m.image.width*m.repeat.x,A=m.image.height*m.repeat.y;g=(g+x)*z,h=(h+y)*A,i=(i+x)*z,j=(j+y)*A,k=(k+x)*z,l=(l+y)*A,c-=a,d-=b,e-=a,f-=b,i-=g,j-=h,k-=g,l-=h,v=i*l-k*j,0!==v&&(w=1/v,o=(l*c-j*e)*w,p=(l*d-j*f)*w,r=(i*e-k*c)*w,s=(i*f-k*d)*w,t=a-o*g-r*h,u=b-p*g-s*h,q.save(),q.transform(o,p,r,s,t,u),q.fill(),q.restore())}function Ea(a,b,c){var g,d=b.x-a.x,e=b.y-a.y,f=d*d+e*e;0!==f&&(g=c/Math.sqrt(f),d*=g,e*=g,b.x+=d,b.y+=e,a.x-=d,a.y-=e)}function Fa(a){t!==a&&(q.globalAlpha=a,t=a)}function Ga(a){u!==a&&(a===THREE.NormalBlending?q.globalCompositeOperation="source-over":a===THREE.AdditiveBlending?q.globalCompositeOperation="lighter":a===THREE.SubtractiveBlending?q.globalCompositeOperation="darker":a===THREE.MultiplyBlending&&(q.globalCompositeOperation="multiply"),u=a)}function Ha(a){x!==a&&(q.lineWidth=a,x=a)}function Ia(a){y!==a&&(q.lineCap=a,y=a)}function Ja(a){z!==a&&(q.lineJoin=a,z=a)}function Ka(a){v!==a&&(q.strokeStyle=a,v=a)}function La(a){w!==a&&(q.fillStyle=a,w=a)}function Ma(a){A.length!==a.length&&(q.setLineDash(a),A=a)}console.log("THREE.CanvasRenderer",THREE.REVISION),a=a||{};var c,d,e,B,C,D,E,I,J,K,L,M,N,ca,da,ea,fa,ga,ha,ia,b=this,f=new THREE.Projector,g=void 0!==a.canvas?a.canvas:document.createElement("canvas"),h=g.width,i=g.height,j=Math.floor(h/2),k=Math.floor(i/2),l=0,m=0,n=h,o=i,p=1,q=g.getContext("2d",{alpha:a.alpha===!0}),r=new THREE.Color(0),s=a.alpha===!0?0:1,t=1,u=0,v=null,w=null,x=null,y=null,z=null,A=[],U=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),Z=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),$=new THREE.Color,_=new THREE.Color,aa={},ja=new THREE.Box2,ka=new THREE.Box2,la=new THREE.Box2,ma=new THREE.Color,na=new THREE.Color,oa=new THREE.Color,pa=new THREE.Vector3,qa=new THREE.Vector3,ra=new THREE.Vector3,sa=new THREE.Matrix3;void 0===q.setLineDash&&(q.setLineDash=function(){}),this.domElement=g,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return q},this.getContextAttributes=function(){return q.getContextAttributes()},this.getPixelRatio=function(){return p},this.setPixelRatio=function(a){void 0!==a&&(p=a)},this.setSize=function(a,b,c){h=a*p,i=b*p,g.width=h,g.height=i,j=Math.floor(h/2),k=Math.floor(i/2),c!==!1&&(g.style.width=a+"px",g.style.height=b+"px"),ja.min.set(-j,-k),ja.max.set(j,k),ka.min.set(-j,-k),ka.max.set(j,k),t=1,u=0,v=null,w=null,x=null,y=null,z=null,this.setViewport(0,0,a,b)},this.setViewport=function(a,b,c,d){l=a*p,m=b*p,n=c*p,o=d*p},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(a,b){r.set(a),s=void 0!==b?b:1,ka.min.set(-j,-k),ka.max.set(j,k)},this.setClearColorHex=function(a,b){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(a,b)},this.getClearColor=function(){return r},this.getClearAlpha=function(){return s},this.getMaxAnisotropy=function(){return 0},this.clear=function(){ka.isEmpty()===!1&&(ka.intersect(ja),ka.expandByScalar(2),ka.min.x=ka.min.x+j,ka.min.y=-ka.min.y+k,ka.max.x=ka.max.x+j,ka.max.y=-ka.max.y+k,s<1&&q.clearRect(0|ka.min.x,0|ka.max.y,ka.max.x-ka.min.x|0,ka.min.y-ka.max.y|0),s>0&&(Ga(THREE.NormalBlending),Fa(1),La("rgba("+Math.floor(255*r.r)+","+Math.floor(255*r.g)+","+Math.floor(255*r.b)+","+s+")"),q.fillRect(0|ka.min.x,0|ka.max.y,ka.max.x-ka.min.x|0,ka.min.y-ka.max.y|0)),ka.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(a,g){if(g instanceof THREE.Camera==!1)return void console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");this.autoClear===!0&&this.clear(),b.info.render.vertices=0,b.info.render.faces=0,q.setTransform(n/h,0,0,-o/i,l,i-m),q.translate(j,k),c=f.projectScene(a,g,this.sortObjects,this.sortElements),d=c.elements,e=c.lights,B=g,sa.getNormalMatrix(g.matrixWorldInverse),ta();for(var p=0,r=d.length;p<r;p++){var s=d[p],t=s.material;if(void 0!==t&&0!==t.opacity){if(la.makeEmpty(),s instanceof THREE.RenderableSprite)C=s,C.x*=j,C.y*=k,va(C,s,t);else if(s instanceof THREE.RenderableLine)C=s.v1,D=s.v2,C.positionScreen.x*=j,C.positionScreen.y*=k,D.positionScreen.x*=j,D.positionScreen.y*=k,la.setFromPoints([C.positionScreen,D.positionScreen]),ja.intersectsBox(la)===!0&&wa(C,D,s,t);else if(s instanceof THREE.RenderableFace){if(C=s.v1,D=s.v2,E=s.v3,C.positionScreen.z<-1||C.positionScreen.z>1)continue;if(D.positionScreen.z<-1||D.positionScreen.z>1)continue;if(E.positionScreen.z<-1||E.positionScreen.z>1)continue;C.positionScreen.x*=j,C.positionScreen.y*=k,D.positionScreen.x*=j,D.positionScreen.y*=k,E.positionScreen.x*=j,E.positionScreen.y*=k,t.overdraw>0&&(Ea(C.positionScreen,D.positionScreen,t.overdraw),Ea(D.positionScreen,E.positionScreen,t.overdraw),Ea(E.positionScreen,C.positionScreen,t.overdraw)),la.setFromPoints([C.positionScreen,D.positionScreen,E.positionScreen]),ja.intersectsBox(la)===!0&&xa(C,D,E,0,1,2,s,t)}ka.union(la)}}q.setTransform(1,0,0,1,0,0)}};